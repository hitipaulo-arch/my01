<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Hor√°rio - Sistema OS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .clock {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }
        
        .date {
            font-size: 20px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group small {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-entrada { background: #2ecc71; }
        .btn-pausa { background: #f39c12; }
        .btn-saida { background: #e74c3c; }
        
        .os-ativas-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .os-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }
        
        .os-item.pausa {
            border-left-color: #f39c12;
        }
        
        .os-info {
            flex: 1;
        }
        
        .os-info h3 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .os-info p {
            color: #7f8c8d;
            font-size: 13px;
            margin: 3px 0;
        }
        
        .os-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-right: 8px;
        }
        
        .os-badge.pausa {
            background: #f39c12;
        }
        
        .btn-fechar {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-fechar:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        .historico {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .historico h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .registro-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .registro-item .tipo {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 5px;
            color: white;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .registro-item .tipo.entrada { background: #2ecc71; }
        .registro-item .tipo.pausa { background: #f39c12; }
        .registro-item .tipo.retorno { background: #3498db; }
        .registro-item .tipo.sa√≠da { background: #e74c3c; }

        /* Badges gen√©ricos */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-os { background: #667eea; color: #fff; }
        .badge-user { background: #ecf0f1; color: #2c3e50; }
        .badge-date { background: #e8f6f3; color: #117a65; }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error, .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        {% include '_top_nav.html' %}

        {% if mensagem %}
        <div class="alert alert-{{ tipo_mensagem or 'success' }}">
            {{ mensagem }}
        </div>
        {% endif %}

        <div class="header">
            <h1>‚è∞ Controle de Hor√°rio</h1>
            <div class="clock" id="clock">--:--:--</div>
            <div class="date" id="date">--</div>
        </div>

        <div class="grid-2col">
            <!-- Formul√°rio de Registro -->
            <div class="card">
                <h2>üìù Novo Registro</h2>
                <form method="POST" action="{{ url_for('controle_horario') }}">
                    <div class="form-group">
                        <label for="nome_usuario">Nome do Funcion√°rio:</label>
                        <input type="text" id="nome_usuario" name="nome_usuario" 
                               placeholder="Digite seu nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="pedido_os">N√∫mero do Pedido/OS: <span style="color: red;">*</span></label>
                        <input type="text" id="pedido_os" name="pedido_os" 
                               placeholder="Ex: 1234" required>
                        <small>Obrigat√≥rio para iniciar trabalho</small>
                    </div>
                    
                    <div class="btn-grid">
                        <button type="submit" name="acao" value="entrada" class="btn btn-entrada">
                            ‚ñ∂ Entrada
                        </button>
                        
                        <button type="submit" name="acao" value="pausa" class="btn btn-pausa">
                            ‚è∏ Pausa
                        </button>
                        
                        <button type="submit" name="acao" value="retorno" class="btn btn-entrada">
                            ‚ñ∂ Retorno
                        </button>
                        
                        <button type="submit" name="acao" value="saida" class="btn btn-saida">
                            ‚èπ Sa√≠da
                        </button>
                    </div>
                </form>
            </div>

            <!-- OS Ativas -->
            <div class="card">
                <h2>üî• OS Ativas ({{ usuarios_ativos|length }})</h2>
                <div class="os-ativas-list">
                    {% if usuarios_ativos %}
                        {% for os in usuarios_ativos %}
                        <div class="os-item {% if os.status == 'pausa' %}pausa{% endif %}">
                            <div class="os-info">
                                <h3>
                                    <span class="os-badge {% if os.status == 'pausa' %}pausa{% endif %}">
                                        OS #{{ os.pedido_os }}
                                    </span>
                                    {{ os.funcionario }}
                                </h3>
                                <p>‚è±Ô∏è In√≠cio: {{ os.horario_entrada }} | Trabalhado: {{ os.tempo_trabalhado }}</p>
                                <p>
                                    {% if os.status == 'pausa' %}
                                    <strong style="color: #f39c12;">‚è∏ EM PAUSA</strong>
                                    {% else %}
                                    <strong style="color: #2ecc71;">‚úì ATIVO</strong>
                                    {% endif %}
                                </p>
                            </div>
                            <form method="POST" action="{{ url_for('controle_horario') }}" style="display: inline;">
                                <input type="hidden" name="funcionario_fechar" value="{{ os.funcionario }}">
                                <input type="hidden" name="pedido_fechar" value="{{ os.pedido_os }}">
                                <button type="submit" name="acao" value="fechar_os" 
                                        class="btn-fechar"
                                        onclick="return confirm('Fechar OS #{{ os.pedido_os }} de {{ os.funcionario }}?')">
                                    ‚úì Fechar
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Nenhuma OS ativa no momento</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Filtros & Hist√≥rico -->
        <div class="historico">
            <h2>üìã Hist√≥rico ({{ total_registros or registros|length }} registros)</h2>
            <form method="GET" action="{{ url_for('controle_horario') }}" style="margin-bottom: 15px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; align-items: end;">
                <div>
                    <label style="font-weight:600; color:#2c3e50;">Usu√°rio</label>
                    <input type="text" name="usuario" value="{{ usuario_filtro }}" placeholder="Nome do funcion√°rio" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
                </div>
                <div>
                    <label style="font-weight:600; color:#2c3e50;">Pedido/OS</label>
                    <input type="text" name="pedido_os" value="{{ os_filtro }}" placeholder="N√∫mero da OS" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
                </div>
                <div>
                    <label style="font-weight:600; color:#2c3e50;">Tipo</label>
                    <select name="tipo" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
                        <option value="" {{ '' == (tipo_filtro or '') and 'selected' or '' }}>Todos</option>
                        <option value="entrada" {{ 'entrada' == (tipo_filtro or '') and 'selected' or '' }}>Entrada</option>
                        <option value="pausa" {{ 'pausa' == (tipo_filtro or '') and 'selected' or '' }}>Pausa</option>
                        <option value="retorno" {{ 'retorno' == (tipo_filtro or '') and 'selected' or '' }}>Retorno</option>
                        <option value="sa√≠da" {{ 'sa√≠da' == (tipo_filtro or '') and 'selected' or '' }}>Sa√≠da</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight:600; color:#2c3e50;">Data In√≠cio</label>
                    <input type="date" name="data_inicio" value="{{ data_inicio_iso }}" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
                </div>
                <div>
                    <label style="font-weight:600; color:#2c3e50;">Data Fim</label>
                    <input type="date" name="data_fim" value="{{ data_fim_iso }}" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
                </div>
                <div>
                    <label style="font-weight:600; color:#2c3e50;">Por p√°gina</label>
                    <input type="number" min="5" max="100" name="per_page" value="{{ per_page }}" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-entrada" type="submit" style="flex:1;">Filtrar</button>
                    <a class="btn btn-pausa" href="{{ url_for('controle_horario') }}" style="text-decoration:none; display:flex; align-items:center; justify-content:center;">Limpar</a>
                </div>
            </form>

            {% if aviso_periodo %}
            <div class="alert alert-warning">{{ aviso_periodo }}</div>
            {% endif %}

            <div style="display:flex; justify-content: flex-end; gap:8px; margin-bottom:10px;">
                <a class="btn btn-pausa" href="{{ url_for('controle_horario', usuario=usuario_filtro, pedido_os=os_filtro, tipo=tipo_filtro, data_inicio=data_inicio, data_fim=data_fim, per_page=per_page, export='csv') }}" style="text-decoration:none;">Exportar CSV</a>
                <a class="btn btn-pausa" href="{{ url_for('controle_horario', usuario=usuario_filtro, pedido_os=os_filtro, tipo=tipo_filtro, data_inicio=data_inicio, data_fim=data_fim, per_page=per_page, export='xlsx') }}" style="text-decoration:none;">Exportar XLSX</a>
            </div>
            {% if registros %}
                {% for reg in registros %}
                <div class="registro-item">
                    <div style="display:flex; align-items:center; flex-wrap: wrap; gap:8px;">
                        <span class="tipo {{ reg.tipo }}">{{ reg.tipo_nome }}</span>
                        <span class="badge badge-user">üë§ {{ reg.funcionario }}</span>
                        {% if reg.pedido_os %}
                        <span class="badge badge-os">#{{ reg.pedido_os }}</span>
                        {% endif %}
                        <span class="badge badge-date">üìÖ {{ reg.data }}</span>
                        {% if reg.observacao %}
                        <span class="badge" style="background:#fff3cd; color:#856404;">üìù {{ reg.observacao }}</span>
                        {% endif %}
                    </div>
                    <div style="font-weight: bold; color: #2c3e50;">
                        {{ reg.horario }}
                    </div>
                </div>
                {% endfor %}
                <div style="display:flex; justify-content: space-between; align-items:center; margin-top: 12px;">
                    <div style="color:#7f8c8d;">P√°gina {{ page }} ‚Äî exibindo {{ registros|length }} de {{ total_registros }}</div>
                    <div style="display:flex; gap:8px;">
                        {% set prev_page = page - 1 %}
                        {% set next_page = page + 1 %}
                        <a class="btn btn-entrada" style="text-decoration:none; {{ 'pointer-events:none; opacity:.6;' if page <= 1 }}" href="{{ url_for('controle_horario', usuario=usuario_filtro, pedido_os=os_filtro, data_inicio=data_inicio, data_fim=data_fim, per_page=per_page, page=prev_page) }}">‚Üê Anterior</a>
                        <a class="btn btn-entrada" style="text-decoration:none; {{ 'pointer-events:none; opacity:.6;' if (page * per_page) >= (total_registros or 0) }}" href="{{ url_for('controle_horario', usuario=usuario_filtro, pedido_os=os_filtro, data_inicio=data_inicio, data_fim=data_fim, per_page=per_page, page=next_page) }}">Pr√≥xima ‚Üí</a>
                    </div>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>Nenhum registro encontrado no per√≠odo</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;
            
            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            const dayName = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            document.getElementById('date').textContent = `${dayName}, ${day} de ${month} de ${year}`;
        }
        
        updateClock();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>
